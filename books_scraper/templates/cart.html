{% extends "base.html" %}

{% block title %}Shopping Cart | Jaggi Books{% endblock %}

{% block categories %}
    {% for category in categories %}
    <li><a href="/category/{{ category.slug }}">{{ category.name }}</a></li>
    {% endfor %}
{% endblock %}

{% block content %}
    <div class="cart-page">
        <h1>Your Shopping Cart</h1>
        
        <div id="cart-empty" class="cart-empty">
            <p>Your cart is empty.</p>
            <a href="/" class="btn btn-primary">Continue Shopping</a>
        </div>
        
        <div id="cart-items" class="cart-items">
            <!-- Cart items will be loaded here via JavaScript -->
        </div>
        
        <div id="cart-summary" class="cart-summary">
            <div class="cart-total">
                <h3>Order Summary</h3>
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span id="cart-subtotal">£0.00</span>
                </div>
                <div class="summary-row">
                    <span>Shipping:</span>
                    <span>£4.99</span>
                </div>
                <div class="summary-row total">
                    <span>Total:</span>
                    <span id="cart-total">£0.00</span>
                </div>
                <button id="checkout-btn" class="btn btn-primary">Proceed to Checkout</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadCart();
    });
    
    function loadCart() {
        fetch('/api/cart')
            .then(response => response.json())
            .then(cart => {
                displayCart(cart);
            })
            .catch(error => console.error('Error loading cart:', error));
    }
    
    function displayCart(cart) {
        const cartItemsEl = document.getElementById('cart-items');
        const cartEmptyEl = document.getElementById('cart-empty');
        const cartSummaryEl = document.getElementById('cart-summary');
        const cartSubtotalEl = document.getElementById('cart-subtotal');
        const cartTotalEl = document.getElementById('cart-total');
        
        if (cart.length === 0) {
            cartItemsEl.style.display = 'none';
            cartSummaryEl.style.display = 'none';
            cartEmptyEl.style.display = 'block';
            return;
        }
        
        cartItemsEl.style.display = 'block';
        cartSummaryEl.style.display = 'block';
        cartEmptyEl.style.display = 'none';
        
        // Clear previous items
        cartItemsEl.innerHTML = '';
        
        // Calculate subtotal
        let subtotal = 0;
        
        // Add table header
        const tableHTML = `
            <table class="cart-table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Total</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="cart-table-body">
                </tbody>
            </table>
        `;
        
        cartItemsEl.innerHTML = tableHTML;
        const tableBodyEl = document.getElementById('cart-table-body');
        
        // Add cart items
        cart.forEach(item => {
            const price = parseFloat(item.price.replace('£', ''));
            const itemTotal = price * item.quantity;
            subtotal += itemTotal;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="product-info">
                    <img src="/images/${item.image_filename}" alt="${item.title}">
                    <div>
                        <h4>${item.title}</h4>
                    </div>
                </td>
                <td class="price">${item.price}</td>
                <td class="quantity">
                    <button class="quantity-btn minus" data-upc="${item.upc}">-</button>
                    <span>${item.quantity}</span>
                    <button class="quantity-btn plus" data-upc="${item.upc}">+</button>
                </td>
                <td class="item-total">£${itemTotal.toFixed(2)}</td>
                <td class="remove">
                    <button class="remove-btn" data-upc="${item.upc}">×</button>
                </td>
            `;
            
            tableBodyEl.appendChild(tr);
        });
        
        // Update subtotal and total
        cartSubtotalEl.textContent = `£${subtotal.toFixed(2)}`;
        const total = subtotal + 4.99; // Adding shipping cost
        cartTotalEl.textContent = `£${total.toFixed(2)}`;
        
        // Add event listeners for quantity buttons and remove buttons
        document.querySelectorAll('.quantity-btn.minus').forEach(btn => {
            btn.addEventListener('click', function() {
                const upc = this.dataset.upc;
                updateQuantity(upc, -1);
            });
        });
        
        document.querySelectorAll('.quantity-btn.plus').forEach(btn => {
            btn.addEventListener('click', function() {
                const upc = this.dataset.upc;
                updateQuantity(upc, 1);
            });
        });
        
        document.querySelectorAll('.remove-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const upc = this.dataset.upc;
                removeItem(upc);
            });
        });
    }
    
    function updateQuantity(upc, change) {
        fetch('/api/cart')
            .then(response => response.json())
            .then(cart => {
                const item = cart.find(item => item.upc === upc);
                if (item) {
                    const newQuantity = item.quantity + change;
                    if (newQuantity <= 0) {
                        removeItem(upc);
                    } else {
                        fetch('/api/cart/update', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                upc: upc,
                                quantity: newQuantity
                            })
                        })
                        .then(response => response.json())
                        .then(cart => {
                            displayCart(cart);
                            updateCartCount(cart);
                        })
                        .catch(error => console.error('Error updating cart:', error));
                    }
                }
            })
            .catch(error => console.error('Error loading cart:', error));
    }
    
    function removeItem(upc) {
        fetch('/api/cart/remove', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                upc: upc
            })
        })
        .then(response => response.json())
        .then(cart => {
            displayCart(cart);
            updateCartCount(cart);
        })
        .catch(error => console.error('Error removing item from cart:', error));
    }
    
    function updateCartCount(cart) {
        const cartCount = cart.reduce((total, item) => total + item.quantity, 0);
        document.getElementById('cart-count').textContent = cartCount;
    }
    
    // Checkout button event listener
    document.getElementById('checkout-btn').addEventListener('click', function() {
        alert('Checkout functionality would be implemented here.');
    });
</script>
{% endblock %}